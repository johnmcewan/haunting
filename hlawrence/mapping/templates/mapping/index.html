{% extends "mapping/base.html" %}

{% load static %}

{% block content %}

    <main class="main-content">
        <div class="map-container">
            <h2 class="map-title">üèöÔ∏è Map of Haunted Locations üèöÔ∏è</h2>
            <div id="map"></div>
        </div>

        <div class="info-section">
            <div class="info-card">
                <h3 class="card-title">üëª Paranormal Encounters</h3>
                <p class="card-text">
                    Lawrence is home to numerous documented paranormal activities. From the historic Eldridge Hotel 
                    to the mysterious campus buildings at KU, each location holds its own dark secrets and ghostly residents.
                </p>
            </div>

            <div class="info-card">
                <h3 class="card-title">üïØÔ∏è Historical Mysteries</h3>
                <p class="card-text">
                    Built on a foundation of Civil War history and frontier tales, Lawrence's haunted locations 
                    are deeply intertwined with the city's tumultuous past. Each spirit has a story to tell.
                </p>
            </div>

            <div class="info-card">
                <h3 class="card-title">üåô Night Tours Available</h3>
                <p class="card-text">
                    Join us for guided tours through Lawrence's most haunted locations. Experience firsthand 
                    the supernatural phenomena that have made this city a hotspot for paranormal investigators.
                </p>
            </div>
        </div>
    </main>

    {{ locationdata|json_script:"mapdata1" }}
    {{ locationdata_user|json_script:"mapdata2" }}


    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // Initialize the map with dark theme
        var map = L.map('map').setView([38.9717, -95.2353], 13);

        // Add a dark tile layer
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);

        // Custom icon for haunted locations
        var hauntedIcon = L.divIcon({
            html: 'üëª',
            iconSize: [30, 30],
            className: 'custom-marker'
        });

        // Custom icon for haunted locations
        var alternatehauntedIcon = L.divIcon({
            html: 'üíÄ',
            iconSize: [30, 30],
            className: 'custom-marker'
        });


        // Function to handle each GeoJSON feature
        function onEachFeature(feature, layer) {
            // Does this feature have a property named popupContent?
            if (feature.properties && feature.properties.popupContent) {
                layer.bindPopup(feature.properties.popupContent);
            }
            
            // Add hover effect to open popup
            layer.on('mouseover', function (e) {
                this.openPopup();
            });
        }

        // Load and display haunted locations from Django data
        try {
            var geojsonFeature1 = JSON.parse(document.getElementById('mapdata1').textContent);
            var geojsonFeature2 = JSON.parse(document.getElementById('mapdata2').textContent);

            // console.log(geojsonFeature1);

            // Check if we have valid GeoJSON data with features
            if (geojsonFeature1 && geojsonFeature1.features && geojsonFeature1.features.length > 0) {
                
                // Add GeoJSON layer with custom styling and popup handling
                L.geoJSON(geojsonFeature1, {
                    pointToLayer: function (feature, latlng) {
                        return L.marker(latlng, {icon: hauntedIcon});
                    },
                    onEachFeature: onEachFeature
                }).addTo(map);

            // Check if we have valid GeoJSON data for the second layer
            if (geojsonFeature2 && geojsonFeature2.features && geojsonFeature2.features.length > 0) {
                var layer2 = L.geoJSON(geojsonFeature2, {
                    pointToLayer: function (feature, latlng) {
                        // You can add a different icon for the second layer if you want.
                        return L.marker(latlng, {icon: alternatehauntedIcon});
                    },
                    onEachFeature: onEachFeature
                }).addTo(map);
                allLayers.push(layer2);
            }

                // Calculate bounds to fit all markers
                var geojsonLayer = L.geoJSON(geojsonFeature1);
                if (geojsonLayer.getBounds().isValid()) {
                    map.fitBounds(geojsonLayer.getBounds(), {padding: [20, 20]});
                }
                
            } else {
                // Fallback to sample locations if no data
                console.log('No haunted location data found, using sample locations');
                addSampleLocations();
            }
        } catch (error) {
            console.error('Error parsing mapdata1:', error);
            // Fallback to sample locations if parsing fails
            addSampleLocations();
        }

        // Fallback function for sample locations
        function addSampleLocations() {
            var sampleLocations = [
                {
                    coords: [38.9717, -95.2353],
                    name: 'Downtown Lawrence',
                    description: 'Historic downtown area with multiple haunted buildings'
                },
                {
                    coords: [38.9576, -95.2478],
                    name: 'University of Kansas',
                    description: 'Campus buildings with reported paranormal activity'
                },
                {
                    coords: [38.9704, -95.2352],
                    name: 'Eldridge Hotel',
                    description: 'Historic hotel with numerous ghost sightings'
                }
            ];

            sampleLocations.forEach(function(location) {
                L.marker(location.coords, {icon: hauntedIcon})
                    .addTo(map)
                    .bindPopup(`<strong>${location.name}</strong><br>${location.description}`)
                    .on('mouseover', function (e) {
                        this.openPopup();
                    });
            });
        }

        // Add spooky map styling
        map.on('zoomend', function() {
            document.querySelectorAll('.leaflet-marker-icon').forEach(function(marker) {
                marker.style.filter = 'drop-shadow(0 0 10px #ff6b35)';
            });
        });

        // Apply initial styling to markers
        setTimeout(function() {
            document.querySelectorAll('.leaflet-marker-icon').forEach(function(marker) {
                marker.style.filter = 'drop-shadow(0 0 10px #ff6b35)';
            });
        }, 500);
    </script>

{% endblock %}
