{% extends "mapping/base.html" %}
{% load static %}

{% block content %}

    <main class="main-content haunting-detail-page">
        
        {% if haunting %}
            <article class="haunting-story">
                
                <h2 class="haunting-name">{{ haunting.haunting_name|default:"A Ghostly Tale" }}</h2>
                
                {% if location.location_photo %}
                <div class="haunting-card-image">
                    <img src="{% static 'images/locations/' %}{{ location.location_photo }}" 
                         alt="{{ location.location_name|default:'Haunted Location' }}"
                         onerror="this.parentElement.style.display='none';">
                </div>
                {% endif %}

                <div class="haunting-meta">
                    {% if haunting.fk_location %}
                        <p class="haunting-location">
                            <span class="icon">üìç</span>
                            <strong>Location:</strong> {{ haunting.fk_location }}
                        </p>
                        <div class="map-container">
                            <h2 class="map-title">üèöÔ∏è Map of Haunted Location üèöÔ∏è</h2>
                            <div id="map"></div>
                        </div>
                    {% endif %}
                    {% if haunting.fk_hauntingtype %}
                        <p class="haunting-type">
                            <span class="icon">üëª</span>
                            <strong>Type of Haunting:</strong> {{ haunting.fk_hauntingtype }}
                        </p>
                    {% endif %}
                </div>

                <hr class="story-separator">

                {% if haunting.haunting_storyabstract %}
                    <section class="story-abstract">
                        <h3>Abstract</h3>
                        <p class="abstract-text">{{ haunting.haunting_storyabstract }}</p>
                    </section>
                    <hr>
                {% endif %}

                {% if haunting.haunting_deathstory %}
                    <section class="death-story">
                        <h3>The Death Story</h3>
                        <p>{{ haunting.haunting_deathstory|linebreaks }}</p>
                    </section>
                    <hr>
                {% endif %}

                {% if haunting.haunting_behavior %}
                    <section class="haunting-behavior">
                        <h3>Behavior and Manifestations</h3>
                        <p>{{ haunting.haunting_behavior|linebreaks }}</p>
                    </section>
                    <hr>
                {% endif %}
                
                {% if haunting.haunting_discoveryofhaunting %}
                    <section class="discovery-story">
                        <h3>Discovery of the Haunting</h3>
                        <p>{{ haunting.haunting_discoveryofhaunting|linebreaks }}</p>
                    </section>
                    <hr>
                {% endif %}

                {% if haunting.haunting_physicaldetails %}
                    <section class="physical-details">
                        <h3>Physical Details</h3>
                        <p>{{ haunting.haunting_physicaldetails|linebreaks }}</p>
                    </section>
                    <hr>
                {% endif %}

                {% if haunting.haunting_timeline %}
                    <section class="haunting-timeline">
                        <h3>Timeline</h3>
                        <p>{{ haunting.haunting_timeline|linebreaks }}</p>
                    </section>
                    <hr>
                {% endif %}

                {% if haunting.haunting_booktext %}
                    <section class="book-excerpt">
                        <h3>Full Story Excerpt</h3>
                        <div class="excerpt-text">{{ haunting.haunting_booktext|linebreaks }}</div>
                    </section>
                    <hr>
                {% endif %}

                <section class="book-reference">
                    {% if haunting.haunting_pagestart and haunting.haunting_pageend %}
                        <p>
                            <span class="icon">üìö</span>
                            This story appears in the book *Haunted Lawrence* on pages 
                            <strong>{{ haunting.haunting_pagestart }}‚Äì{{ haunting.haunting_pageend }}</strong>.
                        </p>
                    {% elif haunting.haunting_pagestart %}
                        <p>
                            <span class="icon">üìö</span>
                            This story appears in the book *Haunted Lawrence* starting on page 
                            <strong>{{ haunting.haunting_pagestart }}</strong>.
                        </p>
                    {% endif %}
                    
                    {% comment %} Note: The short story field (haunting_storyshort) is typically used for a very brief map popup, so it's usually not displayed here, but you can add it if needed. {% endcomment %}
                </section>
                
            </article>
        {% else %}
            <div class="story-not-found-message">
                <h2>Story Not Found </h2>
                <p>The requested ghostly tale could not be located. Perhaps it vanished into the mist. <a href="/map">Return to the Map</a>.</p>
            </div>
        {% endif %}

    </main>



   {{ locationdata|json_script:"mapdata1" }}
    {{ locationdata_user|json_script:"mapdata2" }}

    <script>
        // Initialize particles
        createParticles();
    </script>



    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // Initialize the map with dark theme
        var map = L.map('map').setView([38.9717, -95.2353], 13);

        // Add a dark tile layer
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);

        // Custom icon for haunted locations
        var hauntedIcon = L.divIcon({
            html: 'üëª',
            iconSize: [30, 30],
            className: 'custom-marker'
        });

        // Custom icon for haunted locations
        var alternatehauntedIcon = L.divIcon({
            html: 'üíÄ',
            iconSize: [30, 30],
            className: 'custom-marker'
        });

        // Function to handle each GeoJSON feature
        function onEachFeature(feature, layer) {
            // Does this feature have a property named popupContent?
            if (feature.properties && feature.properties.popupContent) {
                layer.bindPopup(feature.properties.popupContent);
            }
            
            // Add hover effect to open popup
            layer.on('mouseover', function (e) {
                this.openPopup();
            });
        }

        // Load and display haunted locations from Django data
        try {
            var geojsonFeature1 = JSON.parse(document.getElementById('mapdata1').textContent);
            var geojsonFeature2 = JSON.parse(document.getElementById('mapdata2').textContent);

            // console.log(geojsonFeature1);

            // Check if we have valid GeoJSON data with features
            if (geojsonFeature1 && geojsonFeature1.features && geojsonFeature1.features.length > 0) {
                
                // Add GeoJSON layer with custom styling and popup handling
                L.geoJSON(geojsonFeature1, {
                    pointToLayer: function (feature, latlng) {
                        return L.marker(latlng, {icon: hauntedIcon});
                    },
                    onEachFeature: onEachFeature
                }).addTo(map);

            // Check if we have valid GeoJSON data for the second layer
            if (geojsonFeature2 && geojsonFeature2.features && geojsonFeature2.features.length > 0) {
                var layer2 = L.geoJSON(geojsonFeature2, {
                    pointToLayer: function (feature, latlng) {
                        // You can add a different icon for the second layer if you want.
                        return L.marker(latlng, {icon: alternatehauntedIcon});
                    },
                    onEachFeature: onEachFeature
                }).addTo(map);
                allLayers.push(layer2);
            }

                // Calculate bounds to fit all markers
                var geojsonLayer = L.geoJSON(geojsonFeature1);
                if (geojsonLayer.getBounds().isValid()) {
                    map.fitBounds(geojsonLayer.getBounds(), {padding: [20, 20]});
                }
                
            } else {
                // Fallback to sample locations if no data
                console.log('No haunted location data found, using sample locations');
                addSampleLocations();
            }
        } catch (error) {
            console.error('Error parsing mapdata1:', error);
            // Fallback to sample locations if parsing fails
            //addSampleLocations();
        }

        // Fallback function for sample locations
        function addSampleLocations() {
            var sampleLocations = [
                {
                    coords: [38.9717, -95.2353],
                    name: 'Downtown Lawrence',
                    description: 'Historic downtown area with multiple haunted buildings'
                },
                {
                    coords: [38.9576, -95.2478],
                    name: 'University of Kansas',
                    description: 'Campus buildings with reported paranormal activity'
                },
                {
                    coords: [38.9704, -95.2352],
                    name: 'Eldridge Hotel',
                    description: 'Historic hotel with numerous ghost sightings'
                }
            ];

            sampleLocations.forEach(function(location) {
                L.marker(location.coords, {icon: hauntedIcon})
                    .addTo(map)
                    .bindPopup(`<strong>${location.name}</strong><br>${location.description}`)
                    .on('mouseover', function (e) {
                        this.openPopup();
                    });
            });
        }

        // Add spooky map styling
        map.on('zoomend', function() {
            document.querySelectorAll('.leaflet-marker-icon').forEach(function(marker) {
                marker.style.filter = 'drop-shadow(0 0 10px #ff6b35)';
            });
        });

        // Apply initial styling to markers
        setTimeout(function() {
            document.querySelectorAll('.leaflet-marker-icon').forEach(function(marker) {
                marker.style.filter = 'drop-shadow(0 0 10px #ff6b35)';
            });
        }, 500);
    </script>



{% endblock %}